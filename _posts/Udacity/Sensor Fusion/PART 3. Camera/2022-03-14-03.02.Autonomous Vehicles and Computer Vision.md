---
title : "03.02 — Autonomous Vehicles and Computer Vision"
category :
    - Sensor Fusion
tag : 
    - C++
    - https://www.udacity.com/course/sensor-fusion-engineer-nanodegree--nd313

toc: true  
toc_sticky: true 
use_math : true
---



## 1. Levels of Autonomous Driving

### Overview

The purpose of this lesson is to give you an introduction about autonomous driving and computer vision. First, you will learn about the various levels of autonomy which will help you understand the demands on safety and reliability for each level.

Then, we will discuss some typical sensor sets of autonomous vehicles, including the Tesla configuration. The second half of this lesson then introduces you into the basics of camera technology so you can understand properly how images are formed and digitized.

An introduction into the OpenCV computer vision library concludes the lesson, leaving you well prepared for the more challenging parts of the course


### Levels of Autonomous Driving

{% include video id="DQgs4Ty3Cz8" provider="youtube" %}


### Autonomous Vehicles Introduction

According to [CB Insights](https://www.cbinsights.com/research/autonomous-driverless-vehicles-corporations-list/), there are 40+ corporations currently working on autonomous vehicles (as of March 2020). This includes automakers such as Audi, Tesla, BMW, Volvo or GM but also new additions to the automotive space such as Alphabet / Waymo, Uber or Baidu - who hail from totally different industries.

It is expected that the autonomous vehicle market will grow from $54 billion in 2019 to $556 billion in 2026, according to [Allied Market Research estimates](https://www.techworld.com/picture-gallery/data/-companies-working-on-driverless-cars-3641537/). Such growth rates, combined with technological break-throughs of recent years, explain why things are moving so fast and why everyone is trying to get a share of this emerging market.

In addition to autonomous vehicles, there are systems which assist the driver in various driving tasks such as changing lanes, remembering speed signs or braking in time in case the preceding vehicle suddenly decelerates. Such systems are referred to as Advanced Driver Assistance Systems (ADAS) and they are the predecessor of a fully autonomous vehicle. There are some vehicles in the market, however, that imply full autonomy (such as the Tesla Autopilot), but are only an ADAS systems.

Before we analyze a selection of autonomous vehicle prototypes and their respective sensors, let us look at a way to define autonomy - because not all autonomous cars and driver assistance systems are created equal. The following graphic shows the „levels of autonomous driving“, which the Society of Automotive Engineers (now known as SAE International) has defined.


### The SAE Levels of Autonomous Driving

#### Why this section is important for you

Autonomous vehicles are classified into different levels. Depending on the autonomy level, the demands on safety, reliability, and redundancy vary significantly. To design a suitable sensor fusion system in your job role, you need to understand which autonomy level is required and the implications for the development process.

![SOCIETY OF AUTOMOTIVE ENGINEERS (SAE) AUTOMATION LEVELS](https://video.udacity-data.com/topher/2019/April/5cb77419_nhtsa-sae-automation-levels/nhtsa-sae-automation-levels.png)
To have a deeper understanding of the Levels of Autonomous Driving, refer to the table titled "What does this mean for you as a driver?" at the provided [link](https://www.nhtsa.gov/technology-innovation/automated-vehicles-safety).

For many years, ADAS products such as forward collision warning (FCW) or adaptive cruise control (ACC) were the only systems available that provided at least some degree of automation in a selected number of driving situations (e.g. on highways, in cities at low speed).

Tesla has been one of the first companies world-wide to introduce a system into the market that promised a high degree of autonomy, the Autopilot. On the SAE chart however, this system is only at level 2, that means the driver must remain engaged and should monitor the environment at all times.

The step to level 3 is a large one as the driver is no longer required to monitor the environment, even though he must be able to take back control at all times. From a legal viewpoint this means that the responsibility for the driving task is with the car and thus with the manufacturer. This is why we do not see a large number of commercially available vehicles with level 3 systems on board yet. Several manufacturers have announced such systems but at the time of writing, we do not find them in the market. The reason for this is three-fold:

Such systems must be built reliable enough to minimize the number of faulty decisions. Engineers usually solve this problem by adding a large number of sensors to the car, which makes such systems (very) costly. The fear of lawsuits arising from accidents results in an intentionally reduced availability of systems, for example by limiting the driving speed or the scenario (e.g. only in traffic jams on highways with clearly visible lane markings at speeds below 60kph). The readiness of the driver to take control of the vehicle can not be guaranteed at all times. There are many situations in which this is not possible due to human reaction times and alertness levels.

Therefore, many experts believe that level 3 systems will only be a transition step to more advanced systems which are operating on levels 4 and 5. At those levels, the vehicle is capable of performing all driving tasks and the „driver“ is not required to take control. Obviously, such systems will require a strong engineering effort to guarantee driver and road user safety at all times.

In the next section, we will take a closer look at a selection of partially autonomous vehicles and their respective sensor suites. But for now, you should try to test your knowledge by answering the following quiz questions.


### QUIZ QUESTION

Please assess the following systems with regard to their SAE level of autonomy.

Hint: Think carefully about the number of main driving functions the vehicle simultaneously controls.

- Q. The vehicle executes either steering or acceleration while the human driver executes all remaining aspects of the driving task. The driver is responsible for monitoring the driving environment.

- A. Level 1

- Q. The vehicle executes all aspects of the driving task with the expectation that the driver will be available to intervene upon request. The system is responsible for monitoring the driving environment.

- A. Level 3


### Outro

{% include video id="Gby_V8-pJV8" provider="youtube" %}



## 2. Autonomous Vehicle Sensor Sets

### Why this section is important for you?

There is not a single sensor set for autonomous vehicles. Depending on the autonomy level, on the area of application, and the engineering team's mindset, the choices will differ. This section will give you a tour of several sensor sets so you can appreciate the differences between them and identify commonalities, such as the presence of a forward-looking camera.

{% include video id="PggNowlMD5A" provider="youtube" %}

### Why this section is important for you?

There is not a single sensor set for autonomous vehicles. Depending on the autonomy level, on the area of application, and the engineering team's mindset, the choices will differ. This section will give you a tour of several sensor sets so you can appreciate the differences between them and identify commonalities, such as the presence of a forward-looking camera.


### The Uber ATG Autonomous Vehicle

The current version of the Uber autonomous vehicle combines 7 cameras, 1 laser, inertial measurement units, storage and compute units, and radar sensors placed around the car circumference. The set of sensing equipment include:

- Top-mounted 360° Lidar scanner
- 360° coverage radar
- Forward-facing camera array on the top
- Side and rear-facing cameras
- Roof-mounted GPS antennae
- Compute and storage unit

![Uber autonomous vehicle](https://video.udacity-data.com/topher/2020/September/5f61dead_ca9908-edit-1/ca9908-edit-1.jpg)
Uber autonomous vehicle. Image source - [Uber Newsroom - Public Media Assets](https://www.uber.com/en-IN/newsroom/media-assets/uber-atg/)

Let us take a look at those sensor classes one-by one:

1. Cameras: Ubers fleet of modified Volvo XC90 SUVs features a range of cameras on their roofs, plus additional cameras that point to the sides and behind the car. The roof cameras are able to focus both close and far field, watch for braking vehicles, crossing pedestrians, traffic lights, and signage. The cameras feed their material to a central on-board computer, which also receives the signals of the other sensors to create a precise image of the vehicle’s surroundings. Much like human eyes, the performance of camera systems at night is strongly reduced, which makes them less reliable to locate objects with the required detection rates and positional accuracy. This is why the Uber fleet is equipped with two additional sensor types.

2. Radar: Radar systems emit radio waves which are reflected off of (many but not all) objects. The returning waves can be analyzed with regard to their runtime (which gives distance) as well as their shifted frequency (which gives relative speed). The latter property clearly distinguished the radar from the other two sensor types as it is the only one who is able to directly measure the speed of objects. Also, radar is very robust against adverse weather conditions like heavy snow and thick fog. Used by cruise control systems for many years, radar works best when identifying larger objects with good reflective properties. When it comes to detecting smaller or „soft“ objects (humans, animals) with reduced reflective properties, the radar detection performance drops. Even though camera and radar combine well, there are situations where both sensors do not work optimally - which is why Uber chose to throw a third sensor into the mix.

3. Lidar : Lidar works in a similar way to radar, but instead of emitting radio waves it uses infrared light. The roof-mouted sensor rotates at a high velocity and builds a detailed 3D image of its surroundings. In case of the Velodyne VLS-128, a total of 128 laser beams is used to detect obstacles up to a distance of 300 meters. During a single spin through 360 degrees, a total of up to 4 million datapoints per second is generated. Similar to the camera, Lidar is an optical sensor. It has the significant advantage however of "bringing its own light source“, whereas cameras are dependent on ambient light and the vehicle headlights. It has to be noted however, that Lidar performance is also reduced in adverse environmental conditions such as snow, heavy rain or fog. Coupled with low reflective properties of certain materials, a Lidar might thus fail at generating a sufficiently dense point cloud for some objects in traffic, leaving only a few 3D points with which to work. It is thus a good idea to combine Lidar with other sensors to ensure that detection performance is sufficiently high for autonomous navigation through traffic.

The following scene shows the Lidar 3D point cloud generated by the Uber autonomous vehicle as well as the image of the front camera as an overlay in the top-left corner. The overall impression of the reconstructed scene is very positive. If you look closely however, you can observe that the number of Lidar points varies greatly between the objects in the scene.

![Lidar point cloud and other sensor data visualized](https://video.udacity-data.com/topher/2019/April/5cb786f2_camera-2-2/camera-2-2.gif)
Lidar point cloud and other sensor data visualized. Source - [Uber Engineering Blog](https://eng.uber.com/atg-dataviz/)


### Mercedes Benz Autonomous Prototype
Currently, German car maker Mercedes Benz is developing an autonomous vehicle prototype that is equipped with cameras, Lidar and radar sensors, similar to the Uber vehicle. Mercedes uses several cameras to scan the area around the vehicle. Of special interest is a stereo setup consisting of two synchronized cameras, which is able to measure depth by finding corresponding features in both images. The picture below shows the entire host of cameras used by the system. Mercedes states that the stereo camera alone generates a total of 100 gigabytes of data for every kilometer driven.

{% include video id="adI6LK3S97U" provider="youtube" %}

![source](https://video.udacity-data.com/topher/2019/April/5cb78774_draggedimage/draggedimage.png)
[Source](https://www.mercedes-benz.com/en/mercedes-benz/innovation/successful-autonomous-driving-a-pilot-project-by-daimler-and-bosch/)


### The Tesla Autopilot
When the Autopilot system was first sold, it basically was a combination of adaptive cruise control and lane change assist - a set of functions that had long been available with other manufacturers around the globe. The name "Autopilot" implied, however, that the car would be truly autonomous. And indeed did many Tesla owners test the system to its limits by climbing onto the back seat, reading a book, or taking a nap while being driven by the system. On the SAE scale, however, the Autopilot can „only“ be classified as level 2, i.e. the driver is responsible for the driving task at all times.

In October 2016, the Tesla Model S and X sensor set were significantly upgraded and the capabilities of the Autopilot were extended by regular airborne software updates.

The Tesla autopilot system combines several camera sensors with partially overlapping fields of view with a forward-facing radar sensor. The set of cameras, radar, and sonar include the following:

- Rearward looking side camera,
- Wide forward camera,
- Main forward camera,
- Narrow forward camera,
- Radar
- Forward-looking side camera,
- Ultrasonics
- Rearview camera

Watch the video at [Tesla Autopilot homepage](https://www.tesla.com/autopilot) to envision rear-facing cameras and forward-facing cameras for medium-range.

![Overview - Camera, radar, and ultrasonic ranges. Image source - Tesla Public Press-kit](https://video.udacity-data.com/topher/2020/September/5f61aef3_autopilotnew/autopilotnew.jpg)
Overview - Camera, radar, and ultrasonic ranges. Image source - [Tesla Public Press-kit](https://ts.la/TeslaPressKit)

As can be seen in the overview, the system combines several camera sensors with partially overlapping fields of view with a forward-facing radar sensor.

Let us look at each sensor type in turn:

1. Cameras : The forward-facing optical array consists of four cameras with differing focal lengths. The narrow-forward camera captures footage up until 250m in front, the forward camera with a slightly larger opening angle looks up until 150m in front, a wide-angle camera that captures 60m in front, and a set of forward-looking side cameras that capture footage 80m in front and to the side of the car. The wide-angle camera is designed to read road signs and traffic lights, allowing the car to react accordingly. It is debated however, whether this feature can be reliably used in traffic.

2. Radar : The forward-looking radar can see up to 160m ahead of the car. According to Tesla founder Elon Musk it is able to see through "sand, snow, fog—almost anything".

3. Sonar : A 360° ultrasonic sonar detects obstacles in an eight-meter radius around the car. The ultrasonic sensors work at any speed and are used to spot objects in close proximity of the car. The ultrasonic sensors can also be used to assist the car when automatically switching lanes. Their range however, compared to the other sensors of the set, is significantly limited and ends at about 8 meters distance.

As you may have noticed, Tesla is not using a Lidar sensor despite its plans to offer level 4 or even level 5 autonomous driving with this setup. Unlike many other manufacturers who aim at full autonomy such as Uber, Waymo and several others, Tesla is convinced that a set of high-performance cameras coupled with a powerful radar sensor will be sufficient for level 4 / level 5 autonomy. At the time of writing, there is a fierce debate going on about the best sensor set of autonomous vehicles. Tesla argues that the price and packaging disadvantage of Lidar would make the Autopilot unattractive to customers. Harsh critics such as GM's director of autonomous vehicle integration Scott Miller disagrees and argues with the highly elevated safety requirements of autonomous vehicles, which would not be met with cameras and radar alone.


#### On the importance of forward-looking cameras

It has to be noted however that in all sensor setups, be it Uber, Tesla, Waymo or traditional manufacturers such as Mercedes or Audi, cameras are always used. Even though there is an ongoing debate on whether radar or Lidar or a combination of the two would be best, cameras are never in question. It is therefore a good idea to learn about cameras and computer vision, which we will do in great detail in this course.

{% include video id="nrYkozd_9Mc" provider="youtube" %}


### Sensor Selection Criteria

#### Why this section is important for you

Selecting an appropriate sensor set for an autonomous vehicle is a delicate task as you need to balance a range of factors from reliability to cost so your company can identify the sweet spot and select the optimal sensor set.

The design of an autonomous or ADAS-equipped vehicle involves the selection of a suitable sensor set. As you have learned in the preceding section, there is a discussion going on about which combination of sensors would be necessary to reach full (or even partial) autonomy. In this section, you will learn about sensor selection criteria as well as the differences between camera, Lidar and radar with respect to each criterion.

In the following, the most typical selection criteria are briefly discussed.

1. Range : Lidar and radar systems can detect objects at distances ranging from a few meters to more than 200m. Many Lidar systems have difficulties detecting objects at very close distances, whereas radar can detect objects from less than a meter, depending on the system type (either long, mid or short range) . Mono cameras are not able to reliably measure metric distance to object - this is only possible by making some assumptions about the nature of the world (e.g. planar road surface). Stereo cameras on the other hand can measure distance, but only up to a distance of approx. 80m with accuracy deteriorating significantly from there.

2. Spatial resolution : Lidar scans have a spatial resolution in the order of 0.1° due to the short wavelength of the emitted IR laser light . This allows for high-resolution 3D scans and thus characterization of objects in a scene. Radar on the other hand can not resolve small features very well, especially as distances increase. The spatial resolution of camera systems is defined by the optics, by the pixel size on the image and by its signal-to-noise ratio. Details on small object are lost as soon as the light rays emanating from them are spread to several pixels on the image sensor (blurring). Also, when little ambient light exists to illuminate objects, spatial resolution decreases as objects details are superimposed by increasing noise levels of the imager.

3. Robustness in darkness : Both radar and Lidar have an excellent robustness in darkness, as they are both active sensors. While daytime performance of Lidar systems is very good, they have an even better performance at night because there is no ambient sunlight that might interfere with the detection of IR laser reflections. Cameras on the other hand have a very reduced detection capability at night, as they are passive sensors that rely on ambient light. Even though there have been advances in night time performance of image sensors, they have the lowest performance among the three sensor types.

4. Robustness in rain, snow, fog : One of the biggest benefits of radar sensors is their performance under adverse weather conditions. They are not significantly affected by snow, heavy rain or any other obstruction in the air such as fog or sand particles. As an optical system, Lidar and camera are susceptible to adverse weather and its performance usually degrades significantly with increasing levels of adversity.

5. Classification of objects : Cameras excel at classifying objects such as vehicles, pedestrians, speed signs and many others. This is one of the prime advantages of camera systems and recent advances in AI emphasize this even stronger. Lidar scans with their high-density 3D point clouds also allow for a certain level of classification, albeit with less object diversity than cameras. Radar systems do not allow for much object classification.

6. Perceiving 2D structures : Camera systems are the only sensor able to interpret two-dimensional information such as speed signs, lane markings or traffic lights, as they are able to measure both color and light intensity. This is the primary advantage of cameras over the other sensor types.

7. Measure speed : Radar can directly measure the velocity of objects by exploiting the Doppler frequency shift. This is one of the primary advantages of radar sensors. Lidar can only approximate speed by using successive distance measurements, which makes it less accurate in this regard. Cameras, even though they are not able to measure distance, can measure time to collision by observing the displacement of objects on the image plane. This property will be used later in this course.

8. System cost : Radar systems have been widely used in the automotive industry in recent years with current systems being highly compact and affordable. The same holds for mono cameras, which have a price well below US$100 in most cases. Stereo cameras are more expensive due to the increased hardware cost and the significantly lower number of units in the market. Lidar has gained popularity over the last years, especially in the automotive industry. Due to technological advances, its cost has dropped from more than US$75,000 to below US$5,000. Many experts predict that the cost of a Lidar module might drop to less than US$500 over the next few years.

9. Package size : Both radar and mono cameras can be integrated very well into vehicles. Stereo cameras are in some cases bulky, which makes it harder to integrate them behind the windshield as they sometimes may restrict the driver's field of vision. Lidar systems exist in various sizes. The 360° scanning Lidar is typically mounted on top of the roof and is thus very well visible. The industry shift towards much smaller solid-state Lidar systems will dramatically shrink the system size of Lidar sensors in the very near future.

10. Computational requirements : Lidar and radar require little back-end processing. While cameras are a cost-efficient and easily available sensor, they require significant processing to extract useful information from the images, which adds to the overall system cost.

In the following table, the different sensor types are assessed with regard to the criteria discussed above.

<div class="index--atom--lmAIo layout--content--3Smmq"><div class="ltr"><div class="_15vzQlp3FJ8f94suLiPCPf ureact-markdown "><div class="_3iP2TrDXtmCaMBMDFgM-Os"><table class="_31OI8Tmq3yywD_20_EuBtM _1pZkqGvd1RdMO5JXUl_2oA">
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Range measurement</th>
<th style="text-align:center">Robustness in darkness</th>
<th style="text-align:center">Robustness in rain, snow, or fog</th>
<th style="text-align:center">Classification of objects</th>
<th style="text-align:center">Perceiving 2D Structures</th>
<th style="text-align:center">Measure speed / TTC</th>
<th style="text-align:center">Package size</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>Camera</strong></td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">++</td>
<td style="text-align:center">++</td>
<td style="text-align:center">+</td>
<td style="text-align:center">+</td>
</tr>
<tr>
<td style="text-align:center"><strong>Radar</strong></td>
<td style="text-align:center">++</td>
<td style="text-align:center">++</td>
<td style="text-align:center">++</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">++</td>
<td style="text-align:center">+</td>
</tr>
<tr>
<td style="text-align:center"><strong>Lidar</strong></td>
<td style="text-align:center">+</td>
<td style="text-align:center">++</td>
<td style="text-align:center">+</td>
<td style="text-align:center">+</td>
<td style="text-align:center">-</td>
<td style="text-align:center">+</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
</div></div></div><span></span></div>

In the quizzes below, you will complete the table from above by adding +, ++ or - in the empty columns.

...



## 3. Camera Technology Overview


### Why this section is important for you

The computer vision techniques you will soon learn about in this section will enable you to extract meaningful information on the world around the vehicle. But to correctly interpret an image, you need to understand how it has been formed in the first place. If your camera is set up poorly or the optics or the image sensor does not fit the scene you want to capture, even the best computer vision algorithm will not help you. Also, when you get to the point in the course where you will reconstruct a scene in 3D space, you will need to have a solid knowledge of camera geometry and on the various coordinate systems involved.

{% include video id="7qxX1ic-gFI" provider="youtube" %}

In this section you will learn about the basic properties of a camera. We will start from the most basic model called a „pinhole camera“ and then progress to using lenses, which are a key component of camera systems. You need this knowledge in order to understand how a camera creates images, which of its properties influence image appearance and quality and which parameters you have to consider in order to successfully extract meaningful information from these images.


### The Pinhole camera

A very simple camera can be designed by placing a light barrier with a tiny opening (the pinhole) between an object of interest. The light emitted by the object passes through the pinhole and lands on a photosensitive surface which stores the light information as an image. The reason why the pinhole has been made so small is to avoid image blurring due to superimposing rays of light stemming from various parts of the object of interest.

This simple principle has been well known for centuries and was for example used by artists to create photorealistic portraits.

![Camera obscura, by Gemma Frisius, 1845](https://video.udacity-data.com/topher/2020/September/5f61e7ac_1545-gemma-frisius-camera-obscura-sonnenfinsternis-1545-650x337/1545-gemma-frisius-camera-obscura-sonnenfinsternis-1545-650x337.jpg)
Camera obscura, by Gemma Frisius, 1845. Source - [Wikimedia Commons](https://en.wikipedia.org/wiki/File:1545_gemma_frisius_-_camera-obscura-sonnenfinsternis_1545-650x337.jpg)

A formal model of the pinhole camera model is shown below.

![Pinhole camera model](https://video.udacity-data.com/topher/2020/August/5f3a2b28_sf-imageupdates-aug2020-lesson-2.002/sf-imageupdates-aug2020-lesson-2.002.png)
Pinhole camera model

The photosensitive surface on the left is called the image plane whereas the pinhole is called the camera center. The distance between the camera center and the image plane is called the focal length f.

A point P on the object of interest can be mapped to a point P’ on the image plane by casting a beam through the center of projection until it hits the image plane as shown in the figure below.

![Point mapping](https://video.udacity-data.com/topher/2020/August/5f3a2b50_sf-imageupdates-aug2020-lesson-2.003/sf-imageupdates-aug2020-lesson-2.003.png)
Point mapping

In three-dimensional space, the relation between P and P' is expressed by the following equations:

![Equations describing the relationship between P and P'](https://video.udacity-data.com/topher/2020/August/5f3a2b6f_sf-imageupdates-aug2020-lesson-2.004/sf-imageupdates-aug2020-lesson-2.004.png)
Equations describing the relationship between P and P'

Based on these equations, we are able to compute the 2D position of an object on the image plane, given the 3D position of the object in space as well as the focal length of the camera. Note however that the resulting coordinates x’ and y’ are metrical coordinates and not pixel positions yet.

The problem with pinhole cameras is that the amount of light passing through the pinhole is not sufficient to generate a decent image on an image sensor. If one were to increase the amount of light by widening the pinhole opening as shown in the figure below, rays of light from other parts of the object of interest would superimpose each other, leading to a blurring effect: The larger the pinhole, the brighter the image but at the same time, the more severe the blurring of the object on the image plane would be.

![](https://video.udacity-data.com/topher/2020/August/5f3a2b89_sf-imageupdates-aug2020-lesson-2.005/sf-imageupdates-aug2020-lesson-2.005.png)

One way to solve this problem is use a lens, which is able to capture multiple rays of light that emanate from the same point on the object of interest. So let’s look at lenses next.


### Lenses and Aperture
A properly sized and positioned lens refracts all rays of light that emanate from a point P1 on an object in space such that they converge to a single point `(p_1)'` in the image plane. Rays of light passing through the lens center are not refracted however, they continue on as a straight line until they intersect the image plane.

Points on the object that are closer or farther away, such as `P_2`, appear out of focus on the image plane, because the set of light rays emanating from them does not converge in a point but rather in a circle with a finite radius instead. This blurry circle is usually referred to as circle of confusion (COF). To reduce blurring, an aperture can be used, which is a concentric opening of usually adjustable size placed directly behind the lens. The following figure illustrates the principle:

![](https://video.udacity-data.com/topher/2020/August/5f3a2bb4_sf-imageupdates-aug2020-lesson-2.006/sf-imageupdates-aug2020-lesson-2.006.png)

By reducing the diameter of the aperture, light rays passing through the lens on the outer edges are blocked, which reduces the size of the COF on the image plane. It can easily be seen that a smaller aperture results in reduced blurring, but at the expense of low light sensitivity. The larger the aperture, the more light rays are focussed onto the image area, resulting in brighter images with a better signal-to-noise ratio.

So how can we compute where an object in space will appear in the image? Given a 3D point in space, its 2D position on the image plane after passing through a lens can be computed similar to the pinhole camera. In practice, lenses introduce distortion into images, depending on the lens type. The distortion most relevant to practice is called “radial distortion”. It is caused by the focal length of the lens not being uniform over its diameter. Therefore, the magnification effect of the lens changes depending on the distance between the camera center (the optical axis) and the ray of light passing through the lens. If the magnification increases, the resulting distortion effect is called pin cushion distortion. If it decreases, it is called barrel distortion instead. Barrel distortions usually occur, when wide-angle lenses are used. In the figure below, both distortion types are illustrated.

![](https://video.udacity-data.com/topher/2019/April/5cb8cae8_rad027/rad027.png)

When extracting information from camera images, many applications seek to draw conclusions on the spatial location of objects of interest (e.g. vehicles). To get there, the distortion effect of the lens must be removed or at least mitigated. The relevant process is called calibration. For each camera-lens-setup, a calibration procedure must be performed so the distortion parameters can be individually computed. This is usually done by taking a set of pictures of well-known objects such as planar checkerboard patterns, from whose known geometry all lens and image sensor parameters can be robustly derived. The process of removing distortions from a camera image is called rectification. In the image below, the calibration setup used to rectify most of the images in this course is shown. It can easily be seen that lines at both left and right are distorted significantly.

![](https://video.udacity-data.com/topher/2019/April/5cb8cb22_0000000000/0000000000.png)

It is beyond the scope of this course however to go into the details of distortion correction. Most of the images you will be using are already free of lens distortion. When using your own camera setup however, a calibration procedure must be performed when precise measurements and a spatial reconstruction of objects is the goal.

As mentioned before, the projection of points in 3D space onto the image plane does not directly correspond to what we see in actual digital images, which are made up of thousands of picture elements or pixels. To understand how images can be expressed in discrete pixels, we need to take a closer look at the above-mentioned camera model once more. In the figure below, the camera center is shown with a position OO in space along with its own coordinate system with axes ii, jj and kk, where kk is pointing into the direction of the image plane. The position C' where kk intersects the image plane is called the principal point and represents the center of the image coordinate system.The first step after projecting a point PP in space onto the image plane is thus to subtract the principal point coordinates so that the discrete image has its own coordinate system centered in e.g. the lower left corner of the image plane.

Note that the indices of spatial coordinates sometimes differ depending on the area of application and on the author you are reading. In computer vision, points in space are often described with i, j and k or with X, Y and Z. When referring to points on the image plane though, in almost all cases, the coordinate axes are denoted as x and y.

![](https://video.udacity-data.com/topher/2020/August/5f3a2be1_sf-imageupdates-aug2020-lesson-2.007/sf-imageupdates-aug2020-lesson-2.007.png)

The second step in the transformation process is to move from metric to pixel coordinates. To do so, we can use parameters kk and ll provided by the calibration procedure which convert meters to pixels and which can be easily integrated into the projection equations as seen below. Note that in image coordinates, the y-axis has its origin in the upper-left corner and is pointing downwards.

![](https://video.udacity-data.com/topher/2020/August/5f3a2bfa_sf-imageupdates-aug2020-lesson-2.008/sf-imageupdates-aug2020-lesson-2.008.png)

In a later section of this course, we will be mapping Lidar 3D points into the camera image. To do so, we will make use of these equations. Specifically, the product of focal width ff and kk and ll respectively (also termed alpha and beta) will be used in a calibration matrix to simplify the mapping operation significantly.


### Note on image rectification

In many applications (e.g. feature tracking) it makes sense to process the original image to avoid interpolation errors when the rectified image is computed and transformed pixels do not fall exactly onto the center of a discrete pixel in the rectified image but close to the border to another pixel instead. In such a case, it is advisable to locate the features in the unmodified original image and then transform the resulting coordinates using the equations above. When using deep learning based on a set of trained weights, it makes sense to rectify the image first before feeding it to a network - if we would use the original image, distortions (such as from a fish-eye lens) would lead to detection errors as networks are usually trained on a distortion-free image set.

{% include video id="mb4UTgUgu4w" provider="youtube" %}


### Imagers and Bayer Pattern

In this last section, you will learn how rays of light with a certain wavelength are converted into color pixels that can be stored digitally.

When an image is captured by a camera, light passes through the lens and falls on the image sensor. This sensor consists of light sensitive elements that register the amount of light that falls on them and convert it into a corresponding number of electrons. The more light, the more electrons are generated. Once the exposure time is complete, the generated electrons are converted into a voltage, which is finally transformed into a discrete number by means of an A/D-converter.

Currently, there are two main image technologies, which are CCD (Charge-Coupled Device) and CMOS (Complementary Metal-oxide Semiconductor). Both technologies convert electrons into voltage and are inherently color blind, as they can not distinguish the different wavelengths which generate the electrons. To enable color vision, tiny filter elements (also micro-lenses) are placed in front of each pixel which only allow a certain wavelength to pass through. One common way to map wavelength to color is to arrange the filter elements in an RGB (Red, Green, Blue) pattern to allow the primary colors to pass through individually, which gives us three individual images - one for each primary color.

![](https://video.udacity-data.com/topher/2019/April/5cb8cd1d_color-filter-array/color-filter-array.png)

Mixed in different combinations, RGB values can produce most of the colors visible to the human eye. When each discrete color value is coded with 8bits (i.e. 256 values), a total of 16.7 million different colors can be created with the RGB filter concept. The most common way of arranging the RGB filters is called a Bayer pattern, which has alternating rows of red-green and green-blue filters. Since the human eye is more sensitive to green than to red or blue, the Bayer array has twice as many green color filters. When processing color images in a computer vision application, all three RGB layers are available and it has to be decided which color layers to use. If processing power is limited, the different channels are combined into a gray scale image. In the upcoming section on computer vision, you will be introduced to the OpenCV computer vision library. You can take a look at the conversion formula to get from RGB to grayscale which is used in the method cvtColor [here](https://docs.opencv.org/3.1.0/de/d25/imgproc_color_conversions.html)


### CCD vs. CMOS

In a CCD sensor, the electrons collected in each picture element are transferred from the chip through a single or only a few output nodes. The charges are then converted to voltage levels, buffered, and sent out as an analog signal. This signal is then amplified and converted to discrete numbers using an A/D-converter outside the sensor. Originally, CCD technology has had several advantages compared to CMOS, such as higher light sensitivity and less noise. In recent years, however, these differences have all but disappeared. The major disadvantages of CCD are a higher production price and a higher power consumption (up to 100x more than CMOS) , which usually leads to heat issues in the camera.

CMOS sensors were originally used for machine vision applications, but the image quality was poor due to their inferior light sensitivity. With modern CMOS sensors however, both quality and light sensitivity have significantly increased. The CMOS technology has several advantages: Unlike CCD, CMOS chips incorporate amplifiers and A/D-converters, which brings a huge cost advantage. With CCD, those components are located outside of the chip. CMOS sensors also have a faster data readout, lower power consumption, higher noise immunity, and a smaller system size. In automotive applications, almost all cameras use CMOS sensors because of these advantages. The camera setup used for recording most of the image sequences in this course can be found [here](http://www.cvlibs.net/datasets/kitti/setup.php) 

{% include video id="EKAj7KcskGk" provider="youtube" %}


### Review

Now you should have an understanding of how light that is refracted from an object of interest (e.g. a pedestrian) finds its way onto an image sensor after passing through a lens and is finally converted into a discrete color value, that can be processed by a computer vision algorithm. Let’s test your knowledge in a short quiz and then we move on to the next section, which is about basic operations to manipulate and interpret those pixels.



## 4. Camera Technology at MBRDNA

{% include video id="D4ffxdVewCg" provider="youtube" %}



## 5. The OpenCV Computer Vision Library

### Why this section is important for you

You can not reinvent the wheel each time you plan on using a computer vision algorithm for a project. Using a sophisticated and well-tested library of state-of-the-art computer vision libraries is key to the success and timely completion of your project. The OpenCV library is one of the best libraries available and as processing speed is key for computer vision, it has the advantage of being written in C++, which is one the fastest programming languages out there and a standard in autonomous vehicle development.

{% include video id="fAPWyNCrzFo" provider="youtube" %}

Throughout this course, you will be using the OpenCV, which is a cross-platform computer vision library which was originally developed in the year 2000 to provide a common infrastructure for computer vision applications and to accelerate the use of machine vision in science and engineering projects. Originally founded by Intel, the open-source library is now supported by several companies and hundreds of experts all over the globe.

![](https://video.udacity-data.com/topher/2019/April/5cb8d7b7_opencv-logo-with-text-svg-version.svg/opencv-logo-with-text-svg-version.svg.png)

The library has more than 2500 algorithms that can be used to detect and recognize faces, identify objects, classify human actions in videos, track camera movements, track moving objects, perform machine learning and many more. OpenCV is written natively in C++ but has interfaces to Python, Java and Matlab as well. In this course, you will be using the C++ version of OpenCV.

The major advantage in using the OpenCV library is that you will be able to leverage a well-tested set of state-of-the-art computer vision algorithms. Without having to concentrate on the actual implementation of computer vision concepts such as Sobel operators, keypoint detection or machine learning you can use them right out of the box and concentrate on combining them in the right way to develop a working software prototype. Despite this ease of use however, a good understanding of the theories behind those concepts is needed to use them correctly.

In the following, you will familiarize yourself with some basic concepts you will need to get started with OpenCV and to prepare yourself for the more advanced lessons later in the course. The libraries listed below will be used extensively throughout this lecture. They are however only a small part of the entire OpenCV. Later, you will also include some specialized libraries such as flann (Fast Library for Approximate Nearest Neighbors) or dnn (Deep Neural Networks), which will be described only in those sections of this course where they are used.

A note on namespaces: Most OpenCV functions exist within the _cv_ namespace. Usually, to shorten the code, the using namespace cv command is used in many applications. In this course however, this is not done to make it clear when we are using function calls from the OpenCV.


### OpenCV Library Overview

The core module is the section of the library that contains all of the basic object types and their operations. To use the library in your code, the following header has to be included:

```c++
#include "opencv2/core/core.hpp"
```

The highgui module contains user interface functions that can be used to display images or take simple user input. To use the library in your code, the following header has to be included:

```c++
#include "opencv2/highgui/highgui.hpp"
```

In this project, basic functions such as cv::imshow will be used to display images in a window.

The imgproc (image processing) module contains basic transformations on images, such as image filtering, geometric transformations, feature detection and tracking. To use the library in your code, the following header has to be included:

```c++
#include "opencv2/imgproc/imgproc.hpp"
```

The features2d module contains algorithms for detecting, describing, and matching keypoints between images. To use the library in your code, the following header has to be included:

```c++
#include "opencv2/features2d/features2d.hpp"
```


### The OpenCV Matrix Datatype

The basic data type in OpenCV to store and manipulate images is the cv::Mat datatype. It can be used for arrays of any number of dimensions. The data stored in cv::Mat is arranged in a so-called raster scan order. For a two-dimensional array (such as a grayscale image), this means that the data is organized into rows, and each row appears one after the other. A three-dimensional array (e.g. a color image) is arranged in planes, where each plane is filled out row by row, and then the planes are packed one after the other. To see how this works, let us look into the cv::Mat datatype more deeply:

The data inside a cv::Mat variable can be either single numbers or multiple numbers. In the case of multiple numbers (e.g. represented by cv::Scalar), the matrix is referred to as a multichannel array. There are several ways to create and initialize a cv::Mat variable. The create_matrix.cpp file in the workspace below illustrates one way how this can be done.


#### To build and run the code below, use the following steps:

1. Click on the `Desktop` button on the bottom right corner of the workspace. It will take you to another browser tab, opening up the VNC client.

2. Open the `Terminator`. Make sure you are in the project directory. If not, go to the project directory by running

    ```c++
    cd /home/workspace/<project_directory>
    ```

    For the current exercise, the `/home/workspace/OpenCV_exercises` is the project directory.

3. Verify that there must be a `CMakeLists.txt` file present in the project directory. Use `ls` to view files.

4. Create, and go inside the build directory:

    ```
    mkdir build
    cd build
    ```

5. Run the CMake command as:

    ```
    cmake ..
    ```

    The `..` instructs the CMake command to locate the `CMakeLists.txt` file in the parent directory. We should always run CMake outside our source code, which is why we create a build directory. CMake command will generate a cache, `CMakeCache.txt`, in the build directory.

6. Finally, create the executable files with the same name as that of the corresponding `.cpp` files.

    ```
    make
    ```

7. Run the executable file, using the command `./<file_name>` from the current directory, such as:

    ```
    ./create_matrix
    ```

In the code example, the variable m18u is created with 480 rows and 640 columns with a color depth of 8 bit as unsigned char and a single channel (hence the _8UC1). Then, the entire image is set to the 8bit maximum value of 255, which corresponds to white. The function cv::imshow displays the image on the screen. When you execute the code, you should see a white image appear in a window on the screen.

Matrices in OpenCV can also be created with three channels to represent color.

**Here is a short task for you:** In the `create_matrix.cpp` file, create a variable of type cv::Mat named m3_8u which has three channels with a depth of 8bit per channel. Then, set the first channel to 255 using the cv::Scalar datatype and display the result. You can use the documentation here if you get stuck.





















### Summary

{% include video id="qhacFf0G87g" provider="youtube" %}